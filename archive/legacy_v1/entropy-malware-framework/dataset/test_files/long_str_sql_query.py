
"""
Database Query Initializer
Contains definitions for complex SQL queries used in reporting.
"""

class QueryBuilder:
    def __init__(self, debug=False):
        self.debug = debug
        self.queries = {}

    def load_complex_reports(self):
        # A very long SQL query string
        self.queries['financial_report_q3'] = """
        SELECT 
            c.customer_id, 
            c.customer_name, 
            SUM(o.order_total) as total_revenue, 
            COUNT(o.order_id) as order_count, 
            AVG(o.processing_time) as avg_processing_time, 
            MAX(o.order_date) as last_order_date, 
            MIN(o.order_date) as first_order_date,
            (SELECT COUNT(*) FROM support_tickets st WHERE st.customer_id = c.customer_id AND st.status = 'resolved') as resolved_tickets,
            (SELECT SUM(p.amount) FROM payments p WHERE p.order_id IN (SELECT order_id FROM orders WHERE customer_id = c.customer_id) AND p.status = 'completed') as total_paid
        FROM 
            customers c
        JOIN 
            orders o ON c.customer_id = o.customer_id
        LEFT JOIN 
            regions r ON c.region_id = r.region_id
        WHERE 
            o.order_date BETWEEN '2023-01-01' AND '2023-12-31' 
            AND c.status = 'active' 
            AND r.country_code IN ('US', 'CA', 'UK', 'DE', 'FR')
            AND o.order_total > 500
        GROUP BY 
            c.customer_id, c.customer_name 
        HAVING 
            SUM(o.order_total) > 10000 
            AND COUNT(o.order_id) > 5
        ORDER BY 
            total_revenue DESC, order_count DESC 
        LIMIT 100 OFFSET 0;
        -- Data extraction completed for Q3
        """

    def get_user_activity_query(self, user_id):
        # Another long string for query
        base_query = "SELECT u.username, l.login_time, l.ip_address, a.action_type, a.resource_accessed, a.outcome, d.device_type, d.os_version, d.browser_agent FROM users u JOIN login_history l ON u.user_id = l.user_id JOIN activity_log a ON l.session_id = a.session_id JOIN devices d ON l.device_id = d.device_id WHERE u.user_id = ? AND l.login_time >= DATE_SUB(NOW(), INTERVAL 30 DAY) ORDER BY l.login_time DESC;"
        if self.debug:
            print(f"Prepared query for User {user_id}")
        return base_query.replace("?", str(user_id))

    def get_maintenance_script(self):
        """Returns a long database maintenance command string."""
        script = "BEGIN TRANSACTION; UPDATE system_settings SET value = 'maintenance_mode' WHERE key = 'system_status'; DELETE FROM temporary_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 7 DAY); OPTIMIZE TABLE users, orders, products, inventory, transactions, logs, settings; UPDATE metrics SET value = (SELECT COUNT(*) FROM users) WHERE metric_name = 'user_count'; COMMIT;"
        return script

def run_db_setup():
    qb = QueryBuilder(debug=True)
    qb.load_complex_reports()
    
    q3_query = qb.queries.get('financial_report_q3')
    print(f"Loaded Report Query Length: {len(q3_query)}")
    
    activity = qb.get_user_activity_query(1005)
    print(f"Activity Query: {activity}")
    
    maint = qb.get_maintenance_script()
    print(f"Maintenance Script Length: {len(maint)}")

if __name__ == "__main__":
    run_db_setup()
