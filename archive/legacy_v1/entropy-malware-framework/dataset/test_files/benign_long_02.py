"""
Comprehensive custom date and time utilities.
A fully standalone implementation without relying on the datetime module heavily.
Handles leap years, day of year calculations, and string formatting manually.
"""

def is_leap_year(year):
    if year % 400 == 0:
        return True
    if year % 100 == 0:
        return False
    if year % 4 == 0:
        return True
    return False

def get_days_in_month(year, month):
    if month in (1, 3, 5, 7, 8, 10, 12):
        return 31
    if month in (4, 6, 9, 11):
        return 30
    if month == 2:
        return 29 if is_leap_year(year) else 28
    raise ValueError("invalid month")

def get_day_of_year(year, month, day):
    total_days = 0
    for m in range(1, month):
        total_days += get_days_in_month(year, m)
    return total_days + day

def get_total_days_since_0001(year, month, day):
    total = 0
    
    # complete years
    for y in range(1, year):
        total += 366 if is_leap_year(y) else 365
        
    # current year
    total += get_day_of_year(year, month, day)
    return total

def get_date_from_days_since_0001(total_days):
    days = total_days
    year = 1
    
    while True:
        days_in_year = 366 if is_leap_year(year) else 365
        if days > days_in_year:
            days -= days_in_year
            year += 1
        else:
            break
            
    month = 1
    while True:
        days_in_m = get_days_in_month(year, month)
        if days > days_in_m:
            days -= days_in_m
            month += 1
        else:
            break
            
    day = days
    return year, month, day

def add_days(year, month, day, days_to_add):
    total_days = get_total_days_since_0001(year, month, day)
    new_total = total_days + days_to_add
    return get_date_from_days_since_0001(new_total)

def subtract_days(year, month, day, days_to_subtract):
    total_days = get_total_days_since_0001(year, month, day)
    new_total = total_days - days_to_subtract
    if new_total < 1:
        raise ValueError("date underflow")
    return get_date_from_days_since_0001(new_total)

def get_days_between(y1, m1, d1, y2, m2, d2):
    t1 = get_total_days_since_0001(y1, m1, d1)
    t2 = get_total_days_since_0001(y2, m2, d2)
    return abs(t2 - t1)

def get_day_of_week_index(year, month, day):
    # known that 0001-01-01 is monday (index 1)
    total_days = get_total_days_since_0001(year, month, day)
    return (total_days) % 7

def get_day_of_week_string(year, month, day):
    days = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]
    index = get_day_of_week_index(year, month, day)
    return days[index]

def format_date(year, month, day, format_string="YYYY-MM-DD"):
    y_str = str(year).zfill(4)
    m_str = str(month).zfill(2)
    d_str = str(day).zfill(2)
    
    result = format_string.replace("YYYY", y_str)
    result = result.replace("MM", m_str)
    result = result.replace("DD", d_str)
    
    short_m_str = str(month)
    short_d_str = str(day)
    
    result = result.replace("M", short_m_str)
    result = result.replace("D", short_d_str)
    
    return result

def parse_iso_date(date_string):
    parts = date_string.split("-")
    if len(parts) != 3:
        raise ValueError("invalid format, use YYYY-MM-DD")
        
    year = int(parts[0])
    month = int(parts[1])
    day = int(parts[2])
    
    return year, month, day

class CustomCalendar:
    def __init__(self, year, month):
        self.year = year
        self.month = month
        
    def generate_month_view(self):
        first_day_idx = get_day_of_week_index(self.year, self.month, 1)
        num_days = get_days_in_month(self.year, self.month)
        
        # Adjust so monday is 0, sunday is 6
        start_pos = (first_day_idx - 1) % 7 
        if start_pos < 0:
            start_pos += 7
            
        calendar_grid = []
        current_week = ["  "] * start_pos
        
        for day in range(1, num_days + 1):
            current_week.append(str(day).rjust(2))
            
            if len(current_week) == 7:
                calendar_grid.append(current_week)
                current_week = []
                
        if current_week:
            while len(current_week) < 7:
                current_week.append("  ")
            calendar_grid.append(current_week)
            
        return calendar_grid

    def print_calendar(self):
        months = ["january", "february", "march", "april", "may", "june", 
                  "july", "august", "september", "october", "november", "december"]
                  
        print(f"      {months[self.month - 1]} {self.year}")
        print("mo tu we th fr sa su")
        
        grid = self.generate_month_view()
        for week in grid:
            print(" ".join(week))

def get_next_month(year, month):
    if month == 12:
        return year + 1, 1
    return year, month + 1

def get_prev_month(year, month):
    if month == 1:
        return year - 1, 12
    return year, month - 1

def get_quarter(month):
    if month in (1, 2, 3):
        return 1
    if month in (4, 5, 6):
        return 2
    if month in (7, 8, 9):
        return 3
    if month in (10, 11, 12):
        return 4
    return -1

if __name__ == "__main__":
    y, m, d = 2024, 2, 28
    print(f"starting date: {format_date(y, m, d)}")
    print(f"is leap year? {is_leap_year(y)}")
    
    ny, nm, nd = add_days(y, m, d, 2)
    print(f"added 2 days: {format_date(ny, nm, nd)}")
    
    print(f"day of week for {ny}-{nm}-{nd}: {get_day_of_week_string(ny, nm, nd)}")
    
    cal = CustomCalendar(2024, 2)
    cal.print_calendar()
    
    diff = get_days_between(2023, 1, 1, 2024, 1, 1)
    print(f"days in 2023: {diff}")
