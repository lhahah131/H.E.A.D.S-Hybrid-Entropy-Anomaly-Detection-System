import os
import json
import csv
from src.feature_engine.feature_engine import FeatureEngine

DATASET_DIR = "dataset/test_files"
FEATURES_OUTPUT_DIR = "features/per_file"
MASTER_CSV = "features/master_features.csv"

def ensure_directories():
    os.makedirs(FEATURES_OUTPUT_DIR, exist_ok=True)
    os.makedirs(DATASET_DIR, exist_ok=True)

def save_json(file_id, features):
    output_path = os.path.join(FEATURES_OUTPUT_DIR, f"{file_id}.json")
    with open(output_path, "w") as f:
        json.dump(features, f, indent=1)

def append_to_csv(file_id, features):
    file_exists = os.path.isfile(MASTER_CSV)

    with open(MASTER_CSV, "a", newline="") as csvfile:
        writer = csv.writer(csvfile)

        if not file_exists:
            header = ["file_id"] + list(features.keys())
            writer.writerow(header)

        row = [file_id] + list(features.values())
        writer.writerow(row)

def main():
    ensure_directories()

    print("=== DEBUG INFO ===")
    print("Current working directory:", os.getcwd())
    print("Dataset path:", DATASET_DIR)
    try:
        print("Files inside dataset:", os.listdir(DATASET_DIR))
    except Exception as e:
        print(f"Error listing dataset: {e}")
    print("==================")

    # Remove existing master CSV to start fresh
    if os.path.exists(MASTER_CSV):
        try:
            os.remove(MASTER_CSV)
            print(f"Removed old {MASTER_CSV}")
        except PermissionError:
            print(f"Warning: Could not remove {MASTER_CSV} (file might be open). Appending instead.")

    for root, dirs, files in os.walk("dataset"):
        for filename in files:
            if not filename.endswith(".py"):
                continue

            file_path = os.path.join(root, filename)

            if not os.path.isfile(file_path):
                continue

            file_id = os.path.splitext(filename)[0]

            print(f"Processing {filename}...")

            try:
                extractor = FeatureEngine(file_path)
                extractor.read_file()
                features = extractor.extract_features()

                save_json(file_id, features)
                append_to_csv(file_id, features)

                print("Features:", features)
                print("_" * 40)
            except Exception as e:
                print(f"Error processing {filename}: {e}")


if __name__ == "__main__":
    main()