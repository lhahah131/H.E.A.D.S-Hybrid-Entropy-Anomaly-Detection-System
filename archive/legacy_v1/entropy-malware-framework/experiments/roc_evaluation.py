import pandas as pd 
import numpy as np 
import matplotlib.pyplot as plt 

from sklearn.metrics import roc_auc_score, auc, roc_curve
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import IsolationForest

#====================
# LOAD DATA
#====================
df = pd.read_csv("features/master_features.csv")

#====================
# BUAT LABEL PSeudo
#====================
def assign_label(file_id):
    if file_id.startswith("benign"):
        return 0
    if file_id.startswith("Random_entropy"):
        return 1
    if file_id.startswith("base64"):
        return 1
    if file_id == "long_str_html_template":
        return 1
    return 0

df["label"] = df["file_id"].apply(assign_label)

#========================
# Siapkan Feature Matrix
#========================
x = df.drop(columns=["file_id", "label"])
y = df["label"]

#========================
#Scaling
#========================
scaler = StandardScaler()
X_scaled = scaler.fit_transform(x)

#========================
# Train Isolation Forest
#========================
model = IsolationForest(contamination=0.12, random_state=42)
model.fit(X_scaled)

#anomaly_scores_sample  -> sekamin rendah anomali
scores = -model.score_samples(X_scaled)

#========================
# ROC Calculation
#========================
fpr, tpr, thresholds = roc_curve(y, scores)
roc_auc = auc(fpr, tpr)

print("\n=== ROC Evaluatio ====")
print("AUC-ROC Score:", roc_auc)

#========================
# Plot ROC Curve
#========================
plt.figure()
plt.plot(fpr, tpr)
plt.plot([0,1], [0,1])
plt.xlabel("False Positive Rate")
plt.ylabel("True Positive Rate")
plt.title("ROC Curve")
plt.show()