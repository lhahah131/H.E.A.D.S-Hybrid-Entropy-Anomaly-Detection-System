
import pandas as pd
import numpy as np
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import IsolationForest

# ======================
# LOAD DATA
# ======================
try:
    df = pd.read_csv("features/master_features.csv")
except FileNotFoundError:
    print("Error: features/master_features.csv not found. Make sure you run this from the project root.")
    exit(1)

file_ids = df["file_id"]

# ======================
# OPSI 1 — ENTROPY-ONLY FEATURE SET
# ======================
entropy_features = [
    "global_entropy",
    "block_mean_entropy",
    "block_std_entropy",
    "block_entropy_range",
    "digit_ratio",
    "non_printable_ratio",
    "byte_skewness",
    "byte_kurtosis"
]
X = df[entropy_features]

# ======================
# SCALING
# ======================
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

# ======================
# ISOLATION FOREST
# ======================
iso = IsolationForest(
    n_estimators=100,
    contamination=0.05,
    random_state=42
)

iso.fit(X_scaled)

scores      = iso.decision_function(X_scaled)
predictions = iso.predict(X_scaled)
# Prediction: 1 untuk inlier (normal), -1 untuk outlier (anomali)

# ======================
# LABEL-BASED CALIBRATION
# ======================

# Step 1: Tandai file benign berdasarkan prefix nama
is_benign = file_ids.str.startswith("benign_").values

# Step 2: Hitung baseline dari distribusi benign
benign_scores = scores[is_benign]
benign_mean   = np.mean(benign_scores)
benign_std    = np.std(benign_scores)

print(f"\n[Calibration] Benign baseline mean score : {benign_mean:.4f}")
print(f"[Calibration] Benign baseline std  score : {benign_std:.4f}")

calibrated_threshold = benign_mean - 1.5 * benign_std
print(f"[Calibration] Calibrated threshold (1.5std): {calibrated_threshold:.4f}")

calibrated_prediction = np.where(scores < calibrated_threshold, -1, 1)

# ======================
# OPSI 3 — HYBRID RULE GATE
# ======================
def apply_rule_gate(row, pred):
    """
    Jika global_entropy rendah DAN block_mean_entropy juga rendah,
    maka kemungkinan besar bukan malware meski skor IF mencurigakan.
    """
    if row["global_entropy"] < 5.0 and row["block_mean_entropy"] < 4.8:
        return 1  # override ke Normal
    return pred

rule_gated_prediction = [
    apply_rule_gate(df.iloc[i], calibrated_prediction[i])
    for i in range(len(df))
]

# ======================
# OUTPUT RESULTS
# ======================
results = pd.DataFrame({
    "file_id"               : file_ids.values,
    "global_entropy"        : df["global_entropy"].values,
    "block_mean_entropy"    : df["block_mean_entropy"].values,
    "anomaly_score"         : scores,
    "raw_prediction"        : predictions,           # default IsolationForest
    "calibrated_prediction" : calibrated_prediction, # setelah kalibrasi 1.5std
    "final_prediction"      : rule_gated_prediction  # setelah hybrid rule gate
})

results = results.sort_values(by="anomaly_score")

pd.set_option("display.max_rows", None)
pd.set_option("display.max_columns", None)
pd.set_option("display.width", None)
pd.set_option("display.float_format", "{:.4f}".format)

print("\n=== Isolation Forest Results (Entropy-Only + Calibration + Rule Gate) ===")
print("Note: Lower anomaly_score = lebih mencurigakan.")
print("raw_prediction        : -1 = Anomali (default IF)  | 1 = Normal")
print("calibrated_prediction : -1 = Anomali (1.5std)      | 1 = Normal")
print("final_prediction      : -1 = Anomali (+ Rule Gate) | 1 = Normal\n")
print(results[[
    "file_id", "anomaly_score",
    "raw_prediction", "calibrated_prediction", "final_prediction"
]].to_string(index=False))

# Ringkasan
n_raw  = (results["raw_prediction"] == -1).sum()
n_cal  = (results["calibrated_prediction"] == -1).sum()
n_gate = (results["final_prediction"] == -1).sum()

print(f"\n[Summary] Anomali - raw IF             : {n_raw} file")
print(f"[Summary] Anomali - kalibrasi 1.5std   : {n_cal} file")
print(f"[Summary] Anomali - final (rule gate)  : {n_gate} file")
